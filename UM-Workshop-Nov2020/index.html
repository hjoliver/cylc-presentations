<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Cylc 8 Nov 2020</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/hjo.css" id="theme">

		<style>
code {
	 color:red;
}
span.quote {
	 color:orange;
}
		</style>
		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/school-book.css" id="highlight-theme">
	</head>
	<body>
	<div class="reveal">
		 <div class="slides">

				<section>
					 <section>
							<h1>
								 Cylc 8 Project Report
							</h1>
							<h2>
									UM Workshop
									Nov 2020
							</h2>
							<p>Hilary Oliver, NIWA</p>
							<aside class="notes">
							</aside>
					</section>
			</section>

			<section>
					 <section>
							 <h2>Outline</h2>
							 <ul>
									 <li> why is Cylc changing?
									 <li> what's not changing?
									 <li> what is changing?
									 <li> when is it changing?
							 </ul>
							<aside class="notes">
							 why? - reminder!
							</aside>
	  			 </section>
			 </section>
	
			<section>
					 <section>
							 <h2>why is cylc<br/>
									 changing?</h2>
					 </section>
	
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/python2-gtk.png"/>
							</div>
							<!--
							Python 2 RIP image credit: datree.io
							-->
							<aside class="notes">
							<ul>
									<li>Cylc 7 scheduler and CLI are Python 2 based
									<li>Cylc 7 GUI is a Python 2 PyGTK desktop application
									   (several years FTE in it)
									<li>Python 2 is now 10 months past EOL
									<li>PyGTK is obsolete - no Python 3 version
							</ul>
							</aside>
					</section>
	
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/evolution.jpg"/>
							</div>
							<!--
							image credit: Harvard Gazette
							-->
							<aside class="notes">

							<p>Cylc has evolved organically over more than 10 years now.
							Consequently it has accumulated "technical debt" and has some
							serious design flaws that need addressing if it is to remain
							fit-for-purpose as demands on it continue to increase. Cylc 7
							is pretty well optimized but in many ways (scheduling algorithm,
							GUI and network latyer) it is reaching its limits in current
							massive workflows.
							The security model is also considered bespoke and quirky by
							security people, and that was becoming increasingly problematic.
							</p>

							<p>
							NOW the minimal solution was migrate to Python 3 and rewrite the
							GUIs in modern desktop GUI toolkit. But that would not address
							most of the aforementioned problems, AND besides all stakeholders
							wanted more than that. Chiefly, a web UI to allow proper remote
							access and integrate with site identity management. But that 
							had architectural implications, and also required solving some of
							the bigger problems.
							</p>

							</aside>
					</section>
			</section>
	
			<section>
					 <section>
							 <h2>what's <span style="color:red">not</span><br/> changing?</h2>
					 </section>

					 <section>
					 <ul>
							 <li> no global cycle loop 
							 <span style="font-size:50%">(our original raison detre)</span>
							 <li> support Cylc 7 <code>suite.rc</code>
							 <span style="font-size:50%">(with deprecations)</span>
							 <li> support Cylc 7 CLI syntax 
							 <span style="font-size:50%">(with deprecations)</span>
							 <li> core Cylc 7 functionality
							 <span style="font-size:50%">(supported by tests)</span>
					 </ul>
					 <aside class="notes">
							 core: xtriggers, event handling, all control functionality (in
							 general terms, if not in detail or implementation)
					 </aside>
					 </section>

					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cycling-1.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b0.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b00a.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b000a.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b000b.png"/>
							</div>
							<!--
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b00.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b000.png"/>
							</div>
							-->
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2b.png"/>
							</div>
	
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-2.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling.png"/>
							</div>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img class="fragment" src="hjo/media/cycling-running.png"/>
							</div>
							<aside class="notes">
									<p>A remember of our core cycling functionality, which is
									relevant later:</p>
								 <p>Cylc unwinds the cycle loop and gives each task its own
								 cycle point label, to create <b>a single potentially INFINITE
										workflow composed of repeating tasks</b> instead of a
								 sequence of distinct single cycle workflows. So that's an
								 interesting new form of scaling!</p>
							</aside>
					 </section>

					 <!-- ANIM: MUST BE FOLLOWED BY data-state=postanim (PAUSE WORKFLOW) -->
					 <section data-state="anim">
							<div id="infinite-cycling" style="width:900px; height:700px; border: 1px dashed slategray;">
							</div>
							<span style="font-size:10px; position:absolute; bottom:0; left:0">Credit: Oliver Sanders</span>
							<aside class="notes">
									<ul>
										 <li>dark blue tasks are running; light blue finished</li>
											<li>each task advances individually to its next cycle,
											so tasks from many cycles can run at once, as
											dependencies allow</li>
											<li>Cylc maintains an adaptive window on the evolving
											infinite workflow</li>
									</ul>
							</aside>
					 </section>

					 <!-- POSTANIM: PAUSE WORKFLOW ON MOVE TO NEXT SLIDE -->
					 <section data-state="postanim">
							 (pass)
					 </section>

			 </section>

			<section>
					 <section>
							 <h2>what <span style="color:red">IS</span><br/> changing?</h2>
					 </section>

					 <section>
							<h4>what's changing (1/4)</h4>
					 <ul>
							 <li class="fragment"> new architecture:
							 <ul>
									<li> new components:<br/>Hub,  web UI, UI Server</li>
									<li> new network protocols and technologies: <br/>
									Protobuf, ZeroMQ, Tornado, GraphQL, WebSocket</li> 
							 </ul></li>
							 <li class="fragment"> web UI with integrated "gscan"
							 <ul>
									<li> graph-based "window on the workflow"
									<li> shared datastore and incremental update
							 </ul></li>
						</ul>
						</section>

					 <section>
							<h4>what's changing (2/4)</h4>
					 <ul>
							 <li> new "spawn on demand" scheduling
							 <ul>
									<li> dramatically more efficient and scalable
									<ul>
										 <li> real task pool limiting
									</ul></li>
									<li> dramatically more efficient and scalable</li>
									<li> no suicide triggers for path branching</li>
									<li> allows a sensible "window on the workflow"</li>
									<li> task.cycle instances can run out of order</li>
									<li> no leakage of "task pool" internals
									<ul>
										 <li> no <code>cylc insert</code></li>
										 <li> sensible window on the workflow
									</ul>
							 </ul></li>

					 </ul>
					 <aside class="notes">
							complex suite with 1000 tasks/per cycle : runs with max 10
							active
					 </aside>
					 </section>

					 <section>
							<h4>what's changing (3/4)</h4>

					 <ul>
							<ul>
								 <li class="fragment"> <code>rose suite-run</code> migrated to Cylc
							<ul>
								 <li> <span class="quote">platforms</span> support</li>
								 <li> separation of source and run dir</li>
								 <li> suite installation </li>
								 <li> new suite run semantics
								 <ul>
										<li> play, pause, resume (and reflow)</li>
										<li> new run-dir for each new install/run
								 </ul></li>
							</ul> </li>


							 <li class="fragment"> terminology and filenames
							 <ul>
									<li> <span class="quote"> suite -&gt; (work)flow</span>
									<li> <code>suite.rc</code> -&gt; <code>flow.cylc</code>
							 </ul></li>

						</ul>
						</section>

						<section>
							<h4>what's changing (4/4)</h4>
						<ul>
							 <li class="fragment"> code repositories: was 1, now 6+</li>
							 <li class="fragment"> packaging:<br/> <code>conda install cylc</code></li>
							 <li class="fragment"> cylc <span class="quote">plugins</span>
							 <li class="fragment"> documentation (arggh)</li>
							 <li class="fragment"> security: authentication,
							 authorization</li>
							 <li class="fragment"> ...</li>
					 </ul>
					 <aside class="notes">
							<ul>
								 <li> authentication: users and jobs	
								  <li> states: OLD 13 task/job states. NEW 5 task/job states 3
									<ul>
										 <li> submitted, submit-failed, running, succeeded, failed
										 <li> waiting, preparing, expired
									</ul>
								 <li> internals: e.g. self-documenting config classes linked to
								 the user guide build
							</ul>
					 </aside>
					 </section>


		 </section>

		 <section>
				 <section>
						 <h2>Cylc web UI and TUI</h2>
				 </section>
				 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-ui-demo-1.gif"/>
							</div>
					 </section>
  				 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-ui-1.gif"/>
							</div>
					 </section>
	
  				 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-ui-mutations.gif"/>
							</div>
					 </section>
	
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-tui-demo-1.gif"/>
							</div>
					 </section>
			 </section>
	
		 <section>
  				 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-ui-demo-1.gif"/>
							</div>
					 </section>
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/cylc-tui-demo-1.gif"/>
							</div>
					 </section>
			 </section>
	
		 <section>
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/SoS.png"/>
							</div>
					 </section>
					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/SoD.png"/>
							</div>
							<aside class="notes">
								 the "task pool": Python objects that represent the tasks in
								 the infinite graph that the scheduler has to be aware of at
								 this point in time.
								 <ul>
										<li> small suite: 4 tasks per cycle
										<li> Cylc 0-7: at least one running or waiting cycle-point
										instance of every task in the suite, PLUS all succeeded
										tasks in the current window .
										<ul>
											 <li> in this example, active tasks (green) spread of 5
											 cycle points: task pool 16 (but up to 20 or more)
										</ul>
										<li> Cylc 8: task pool 3!! (actually 2, blue not necessary
										here - just to show runhead limited waiting task)
								 </ul>

							</aside>
					 </section>


		 </section>


		 <section>

					 <section>
							<div style="width:100%; position:absolute; left:0; top:0"/>
								 <img src="hjo/media/mug-shots.png"/>
							</div>
					 </section>

		 </section>

		 </div>
	</div>


		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/fullscreen/plugin.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
                hash: true,
								width: 960,
                height: 800,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealFullscreen ],
				transition:'none',
			});
		</script>
		
		<script>
      Reveal.on('beer', event => {
							count_down();
      }, false);


       function count_down() {
					// Set the date we're counting down to
					var countDownDate = new Date().getTime() + 45*60000;
					// Update the count down every 1 second
					var x = setInterval(function() {
									var now = new Date().getTime();
									// Find the distance between now and the count down date
									var d = countDownDate - now;
									// Time calculations for days, hours, minutes and seconds
									var min = Math.floor((d % (1000 * 60 * 60)) / (1000 * 60));
									var sec = Math.floor((d % (1000 * 60)) / 1000);
									// Display the result in the element with id="cdown"
									document.getElementById("cdown").innerHTML = min.toString().padStart(2, "0") + ":" + sec.toString().padStart(2,"0");
									}, 1000);
			}
		</script>

		<script src="hjo/js/minicylc.js"></script>
	  <script type="text/javascript" src="hjo/js/jquery.min.js"></script>

		<script>

      // write dependencies
      const deps = [];
      for (let i=0; i<100; i++) {
        deps.push(`a${i} => c${i} => d${i}`);
        deps.push(`a${i} => b${i}`);
        deps.push(`a${i} => a${i+1}`);
        deps.push(`c${i} => b${i+1}`);
      }

      // create graph
      const infinite_animation = $('<embed style="background:#eaeaea;"/>')
        .addClass('minicylc')
        .data('focus', true)
        .data('randomFactor', 0.5)
        .data('dependencies', deps.join('//'))
        .attr('src', 'hjo/media/infinite-workflow.svg')[0]
      $('#infinite-cycling').append(infinite_animation);

      const infinite_animation_2 = $('<embed style="background:#eaeaea;"/>')
        .addClass('minicylc')
        .data('focus', true)
        .data('randomFactor', 0.5)
        .data('dependencies', deps.join('//'))
				.data('succeed_fill', 'white')
        .attr('src', 'hjo/media/infinite-workflow.svg')[0]
      $('#infinite-cycling-2').append(infinite_animation_2);

      const infinite_animation_3 = $('<embed style="background:#eaeaea;"/>')
        .addClass('minicylc')
        .data('focus', true)
        .data('randomFactor', 0.5)
        .data('dependencies', deps.join('//'))
				.data('succeed_fill', 'white')
				.data('reflow', 'a7')
        .attr('src', 'hjo/media/infinite-workflow.svg')[0]
      $('#infinite-cycling-3').append(infinite_animation_3);


			const infinite_worklow = undefined
			const infinite_worklow_2 = undefined
			const infinite_worklow_3 = undefined

      Reveal.on('anim', event => {
						console.log(event);
						if (typeof infinite_workflow === 'undefined') {
							 infinite_workflow = new MiniCylc(infinite_animation, true);
							 infinite_workflow.run();
						}
						infinite_workflow.release();
      }, false);

      Reveal.on('postanim', event => {
						infinite_workflow.hold();
						}, false);

      Reveal.on('anim-2', event => {
						if (typeof infinite_workflow_2 === 'undefined') {
							 infinite_workflow_2 = new MiniCylc(infinite_animation_2, true);
							 infinite_workflow_2.run();
						}
						infinite_workflow_2.release();
      }, false);

      Reveal.on('postanim-2', event => {
						infinite_workflow_2.hold();
						}, false);

      Reveal.on('anim-3', event => {
						if (typeof infinite_workflow_3 === 'undefined') {
							 infinite_workflow_3 = new MiniCylc(infinite_animation_3, true);
							 infinite_workflow_3.run();
						}
						infinite_workflow_3.release();
						}, false);

      Reveal.on('postanim-3', event => {
						infinite_workflow_3.hold();
						}, false);

     </script>
		
	</body>
</html>
